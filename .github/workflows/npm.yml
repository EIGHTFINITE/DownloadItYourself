name: npm

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * *'

jobs:
  npm_linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.3.4
      with:
        path: EIGHTFINITE-build
    - name: npm
      shell: bash
      run: |
        cd EIGHTFINITE-build
        docs/tools/git-config.sh
        git fetch --depth 1 origin +refs/tags/artifacts:refs/tags/artifacts --no-tags
        git restore --source=artifacts -- bin/
        cd ..
        echo '{
          "private": "true"
        }' > package.json
        cp EIGHTFINITE-build/.npmrc .npmrc
        sudo ln -sf "$(pwd)/EIGHTFINITE-build/bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node" /usr/local/bin/node
        cd EIGHTFINITE-build
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js install --offline=false
        rm -rf .npm/
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js dedupe
        rm -rf .npm/
        rm -r node_modules/@types/
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js dedupe
        rm -rf .npm/
        sed -i '/"@types\/node": "/d' -- 'node_modules/electron/package.json'
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js ls --unicode=false --loglevel=silent | grep -v ' deduped' || true
        rm -rf .npm/
        cd ..
        EIGHTFINITE-build/bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node EIGHTFINITE-build/bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js install ./EIGHTFINITE-build
        rm -rf .npm/
  npm_windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2.3.4
      with:
        path: EIGHTFINITE-build
    - name: npm
      shell: bash
      run: |
        cd EIGHTFINITE-build
        docs/tools/git-config.bat
        git fetch --depth 1 origin +refs/tags/artifacts:refs/tags/artifacts --no-tags
        git restore --source=artifacts -- bin/
        cd ..
        echo '{
          "private": "true"
        }' > package.json
        cp EIGHTFINITE-build/.npmrc .npmrc
        rm -r "C:\\Program Files\\nodejs"
    - name: npm
      shell: cmd
      run: |
        mklink /d "C:\Program Files\nodejs" "%cd%\EIGHTFINITE-build\bin\windows\x64\node\node-v12.10.0-win-x64"
    - name: npm
      shell: bash
      run: |
        cd EIGHTFINITE-build
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd install --offline=false
        rm -rf .npm/
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd dedupe
        rm -rf .npm/
        rm -r node_modules/@types/
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd dedupe
        rm -rf .npm/
        sed -i '/"@types\/node": "/d' -- 'node_modules/electron/package.json'
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd ls --unicode=false --loglevel=silent | grep -v ' deduped' || true
        rm -rf .npm/
        cd ..
        EIGHTFINITE-build/bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd install .\\EIGHTFINITE-build
        rm -rf .npm/
  audit_linux:
    runs-on: ubuntu-latest
    needs: npm_linux
    if: needs.npm_linux.result == 'success'
    steps:
    - uses: actions/checkout@v2.3.4
      with:
        path: EIGHTFINITE-build
    - name: audit
      shell: bash
      run: |
        cd EIGHTFINITE-build
        docs/tools/git-config.sh
        git fetch --depth 1 origin +refs/tags/artifacts:refs/tags/artifacts --no-tags
        git restore --source=artifacts -- bin/
        cd ..
        sudo ln -sf "$(pwd)/EIGHTFINITE-build/bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node" /usr/local/bin/node
        cd EIGHTFINITE-build
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js install --offline=false
        rm -rf .npm/
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js dedupe
        rm -rf .npm/
        rm -r node_modules/@types/
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js dedupe
        rm -rf .npm/
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node node_modules/npm/bin/npm-cli.js audit
        rm -rf .npm/
        cd ..
  audit_windows:
    runs-on: windows-latest
    needs: npm_windows
    if: needs.npm_windows.result == 'success'
    steps:
    - uses: actions/checkout@v2.3.4
      with:
        path: EIGHTFINITE-build
    - name: audit
      shell: bash
      run: |
        cd EIGHTFINITE-build
        docs/tools/git-config.bat
        git fetch --depth 1 origin +refs/tags/artifacts:refs/tags/artifacts --no-tags
        git restore --source=artifacts -- bin/
        cd ..
        rm -r "C:\\Program Files\\nodejs"
    - name: audit
      shell: cmd
      run: |
        mklink /d "C:\Program Files\nodejs" "%cd%\EIGHTFINITE-build\bin\windows\x64\node\node-v12.10.0-win-x64"
    - name: audit
      shell: bash
      run: |
        cd EIGHTFINITE-build
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd install --offline=false
        rm -rf .npm/
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd dedupe
        rm -rf .npm/
        rm -r node_modules/@types/
        bin/windows/x64/node/node-v12.10.0-win-x64/npm.cmd dedupe
        rm -rf .npm/
        bin/windows/x64/node/node-v12.10.0-win-x64/node.exe node_modules/npm/bin/npm-cli.js audit
        rm -rf .npm/
        cd ..
