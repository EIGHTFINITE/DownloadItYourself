name: Vendor Node Modules

on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 1
    - name: Vendor Node Modules
      shell: bash
      run: |
        docs/scripts/configure-git.sh
        if [[ $(git config user.name | head -c1 | wc -c) -eq 0 ]]; then git config --local user.name "GitHub"; fi
        if [[ $(git config user.email | head -c1 | wc -c) -eq 0 ]]; then git config --local user.email "noreply@github.com"; fi
        rm -r node_modules/
        rm package-lock.json
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js install --no-optional --no-bin-links --loglevel=error
        grep -rl '"_where"' node_modules/ | xargs sed -i '/_where/d'
        grep -rl '"man": \[' node_modules/ | xargs sed -i '/"man": \[/,/\],/d'
        git add -A
        git diff-index --quiet HEAD || git commit -m "Update Node Modules"
    - uses: ad-m/github-push-action@master
      with:
        branch: "refs/heads/actions/node-vendor"
        force: true
        github_token: ${{ secrets.GITHUB_TOKEN }}
    - uses: repo-sync/pull-request@master
      with:
        source_branch: "actions/node-vendor"
        pr_title: "Update Node Modules"
        pr_body: "Update Vendored Node Modules to the latest versions found in https://github.com/${{ github.repository }}/blob/master/package.json"
        pr_label: "dependencies"
        github_token: ${{ secrets.GITHUB_TOKEN }}
