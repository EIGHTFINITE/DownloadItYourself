name: Vendor Node Modules

on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Vendor Node Modules
      shell: bash
      run: |
        docs/scripts/configure-git.sh
        rm -r node_modules/
        rm package-lock.json
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js install --no-optional --no-bin-links --ignore-scripts
        bin/linux/x64/node/node-v12.10.0-linux-x64/bin/node bin/linux/x64/node/node-v12.10.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js dedupe
        find node_modules/ -type f -name 'package.json' -exec sed -i '/"_where"/d' -- '{}' ';'
        find node_modules/ -type f -name 'package.json' -exec sed -i '/"man": \[/,/\],/d' -- '{}' ';'
        sed -i 's/require(\x27request\x27)/require(\x27postman-request\x27)/g' -- 'node_modules/cloudscraper/index.d.ts'
        sed -i '
        s/require(\x27request\x27)/require(\x27postman-request\x27)/g
        s/npm install request --save/npm install postman-request --save/g
        ' -- 'node_modules/request-promise/lib/rp.js'
        sed -i -E 's/"request": ".+?"/"postman-request": "latest"/g' -- 'node_modules/cloudscraper/package.json'
        sed -i -E 's/"request": ".+?"/"postman-request": "latest"/g' -- 'node_modules/request-promise/package.json'
        sed -i -E 's/"request": ".+?"/"postman-request": "latest"/g' -- 'node_modules/request-promise-core/package.json'
        git update-index --assume-unchanged "node_modules/electron/path.txt"
        find node_modules/ -mindepth 2 -maxdepth 3 -type f -name 'package.json' -exec bash -c 'path="{}"; git add -- "${path:0:-13}"; git -c user.name="GitHub" -c user.email="noreply@github.com" commit --author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>" -m"Update ${path:13:-13}"' ';'
        git add -A
        git reset -- package-lock.json
        git -c user.name="GitHub" -c user.email="noreply@github.com" commit --author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>" -m"Delete unused dependencies" || true
    - uses: peter-evans/create-pull-request@master
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Update package-lock.json
        author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        committer: GitHub <noreply@github.com>
        title: Update Node Modules
        body: |
          Update Vendored Node Modules to the latest versions found in https://github.com/${{ github.repository }}/blob/master/package.json
        labels: dependencies
        branch: actions/node-vendor
        base: master
